---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
#install.packages("openxlsx")

library(ggplot2)
library(data.table)

#Change to match you particular file path.
filename <- "pathname.csv"
df <- read.csv(filename)
dim(df)
head(df)

#Creates a subset of the dataframe with the relevant columns. May need to adjust if your analysis pipeline is different.
sub_df <- df[, c("FileName_Hela_cells", "Count_Nuclei", "Count_Relate_foci", "Count_Relate_GFP")]

#Renames the FileName_Hela_cells --> "Names"
colnames(sub_df)[1] <- "Names"


#Creates a function that changes the long output that CellProfiler produces (i.e., DrugX_1_2_(c1+c2+c3).TIF) to condensed name (i.e., DrugX 100 uM)
#Will need to adjust this depending on the drug your trial is using:
replace_names <- function(x) {
  x <- gsub("(DMSO).*", "DMSO", x)
  #Change this line depending on the drug being used.
  x <- gsub("(DrugX).*", "Drug X uM", x)
  #Can add gsub edits for additional drugs tested (e.g., x <- gsub("(Drug2X).*", "Drug2X uM", x))
}
  
#Applies the replace_names function onto subset dataframe.
sub_df$Names <- sapply(sub_df$Names, replace_names)


#Creates new columns that are the averaged foci per nucleus (in this example we are looking for 2 different types of foci)
#Change variable names depending on the data you are analyzing
sub_df$foci_per_nuc <- sub_df$Count_Relate_foci / sub_df$Count_Nuclei
sub_df$MLF2_foci_per_nuc <- sub_df$Count_Relate_GFP / sub_df$Count_Nuclei

#Groups the data by specific readouts and generates the mean and standard deviation of each group (Repeat for each readout):
#NPC antibody readout:
mab414_mean <- aggregate(sub_df$foci_per_nuc, list(sub_df$Names), FUN = mean)
mab414_sd <- aggregate(sub_df$foci_per_nuc, list(sub_df$Names), FUN = sd)
mab414_data <- setNames(merge(mab414_mean, mab414_sd, "Group.1"), c("Drug", "Mean", "SD"))

#MLF2-GFP readout:
MLF2_mean <- aggregate(sub_df$MLF2_foci_per_nuc, list(sub_df$Names), FUN = mean)
MLF2_sd <- aggregate(sub_df$MLF2_foci_per_nuc, list(sub_df$Names), FUN = sd)
MLF2_data <- setNames(merge(MLF2_mean, MLF2_sd, "Group.1"), c("Drug", "Mean", "SD"))


#Generates both boxplots and barplots for each readout type:
#Mab414 Foci charts:
mab414_barplot <- ggplot(mab414_data, aes(x = Drug, y = Mean, fill = Drug)) +
  geom_bar(stat = "identity") +
  labs(y = "Value", x = " ") +
  geom_errorbar( aes(x=Drug, ymin=Mean-SD, ymax=Mean+SD), width=0.25, colour="black", alpha=0.9, size=0.6) +
  stat_summary(fun.data = mean_sdl, geom = "text", aes(label = round(..y.., 2)), vjust = -1.1, hjust = 1.1) +
  labs(y = "Mab414 Foci per Nucleus:", title = "[DrugX] vs Avg. Mab414 Foci:") +
  theme_classic()  +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  theme(axis.title.y = element_text(size = 12)) +
  theme(axis.text.x = element_text(size = 10))
mab414_barplot

mab414_boxplot <- boxplot(sub_df$foci_per_nuc ~ sub_df$Names, col = c("red", "green"), ylab = "Mab414 Foci", xlab = " ", main = "[DrugX] vs Avg. Mab414 Foci:")
means = tapply(sub_df$foci_per_nuc, sub_df$Names, mean)
points(means, col = "black", pch = 19, cex = 1.3)
text(x = c(1:3), y = means + 8, labels = round(means, 1))
mab414_boxplot


#MLF2 Foci charts:
MLF2_barplot <- ggplot(MLF2_data, aes(x = Drug, y = Mean, fill = Drug)) +
  geom_bar(stat = "identity") +
  labs(y = "Value", x = " ") +
  geom_errorbar( aes(x=Drug, ymin=Mean-SD, ymax=Mean+SD), width=0.25, colour="black", alpha=0.9, size=0.6) +
  stat_summary(fun.data = mean_sdl, geom = "text", aes(label = round(..y.., 2)), vjust = -1.1, hjust = 1.1) +
  labs(y = "MLF2 Foci per Nucleus:", title = "[DrugX] vs Avg. MLF2 Foci:") +
  theme_classic()  +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  theme(axis.title.y = element_text(size = 12)) +
  theme(axis.text.x = element_text(size = 10))
MLF2_barplot

MLF2_boxplot <- boxplot(sub_df$MLF2_foci_per_nuc ~ sub_df$Names, col = c("red", "green"), ylab = "MLF2 Foci", xlab = " ", main = "[DrugX] vs Avg. MLF2 Foci:")
means = tapply(sub_df$MLF2_foci_per_nuc, sub_df$Names, mean)
points(means, col = "black", pch = 19, cex = 1.3)
text(x = c(1:3), y = means + 8, labels = round(means, 1))
MLF2_boxplot



#For just two variables, use two-tailed unpaired student t-test, or Mann-Whitney (Wilcox)-if not normally distributed.

#Can visually inspect the normality of the distribution for each sample set:
qqnorm(sub_df[sub_df$Names == "DMSO",]$foci_per_nuc, main = "Mab414 Foci/Nuc (DMSO):")
qqnorm(sub_df[sub_df$Names == "DrugX uM",]$foci_per_nuc, main = "Mab414 Foci/Nuc (DrugX):")

qqnorm(sub_df[sub_df$Names == "DMSO",]$MLF2_foci_per_nuc, main = "MLF2 Foci/Nuc (DMSO):")
qqnorm(sub_df[sub_df$Names == "DrugX uM",]$MLF2_foci_per_nuc, main = "MLF2 Foci/Nuc (DrugX):")


#Uses the Shapiro test to determine normality for both the DMSO and the drug samples for each readout type.
#If both drug and DMSO sample data are normally distributed (i.e., p-value >= 0.05), then a two-tailed unpaired student t-test is performed.
#If either the drug or DMSO sample data are not normally distributed (i.e., p-value <= 0.05), Mann-Whitney (Wilcox) test is performed.
#The name of the test type (Whitney or t-test) and the generated p-value are stored in a vector before being added to the readout group summary dataframe.


#Mab414 Foci:
if (shapiro.test(sub_df[sub_df$Names == "DMSO", ]$foci_per_nuc)[2] >= 0.05 & shapiro.test(sub_df[sub_df$Names == "DrugX uM", ]$foci_per_nuc)[2] >= 0.05) {
  p_val_Mab414_drugx <- c("two-tailed unpaired t-test", t.test(sub_df[sub_df$Names == "DrugX uM", ]$foci_per_nuc, sub_df[sub_df$Names == "DMSO", ]$foci_per_nuc, alternative = "two.sided", var.equal = FALSE)[3])
} else { p_val_Mab414_drugx <- c("Wilcox Test", wilcox.test(sub_df[sub_df$Names == "DrugX uM", ]$foci_per_nuc, sub_df[sub_df$Names == "DMSO", ]$foci_per_nuc)[3])
}

mab414_data$Foci_Tested <- "Mab 414"
mab414_data$Test_Type <- c(NA, p_val_Mab414_drugx[[1]])
mab414_data$P_val <- c(NA, p_val_Mab414_drugx[[2]])


#Repeat for the second readout (MLF2-GFP, in this case):
#MLF2 p-test:
if (shapiro.test(sub_df[sub_df$Names == "DMSO", ]$MLF2_foci_per_nuc)[2] >= 0.05 & shapiro.test(sub_df[sub_df$Names == "DrugX uM", ]$MLF2_foci_per_nuc)[2] >= 0.05) {
  p_val_GFP_DrugX <- c("two-tailed unpaired t-test", t.test(sub_df[sub_df$Names == "DrugX uM", ]$MLF2_foci_per_nuc, sub_df[sub_df$Names == "DMSO", ]$MLF2_foci_per_nuc, alternative = "two.sided", var.equal = FALSE)[3])
} else { p_val_GFP_DrugX <- c("Wilcox Test", wilcox.test(sub_df[sub_df$Names == "DrugX uM", ]$MLF2_foci_per_nuc, sub_df[sub_df$Names == "DMSO", ]$MLF2_foci_per_nuc)[3])
}

MLF2_data$Foci_Tested <- "MLF2"
MLF2_data$Test_Type <- c(NA, p_val_GFP_DrugX[[1]])
MLF2_data$P_val <- c(NA, p_val_GFP_DrugX[[2]])


combined_Dataframe <- format(rbind(mab414_data, MLF2_data), digits = 4)
combined_Dataframe


#Export the original dataframe and summary information into excel sheet.
wb <- createWorkbook()

addWorksheet(wb, "original_df")
writeData(wb, "original_df", df)
addWorksheet(wb, "summary_info")
writeData(wb, "summary_info", combined_Dataframe)

saveWorkbook(wb, "pathname/cellprofiler_results.xlsx", overwrite = TRUE)

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
